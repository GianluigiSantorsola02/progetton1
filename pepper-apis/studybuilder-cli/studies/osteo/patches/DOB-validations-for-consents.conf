"rules": [
  {
  "Code": "CONSENT_ASSENT",
  "validation": [
    {
    "stableIds": ["CONSENT_ASSENT_CHILD_DOB"],
    "precondition": """ user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].questions["CONSENT_ASSENT_CHILD_DOB"].isAnswered() """",
    "expression": """ user.studies["CMI-OSTEO"].forms["PREQUAL"].hasInstance() && (
        ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["COUNTRY"].answers.hasOption("US")
          && (
            ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["STATE"].answers.hasOption("AL")
              && user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].questions["CONSENT_ASSENT_CHILD_DOB"].answers.ageAtLeast(19, YEARS)
            ) || (
              !user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["STATE"].answers.hasOption("AL")
              && user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].questions["CONSENT_ASSENT_CHILD_DOB"].answers.ageAtLeast(18, YEARS)
            )
          )
        ) || (
          user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["COUNTRY"].answers.hasOption("CA")
          && (
            ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
              && user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].questions["CONSENT_ASSENT_CHILD_DOB"].answers.ageAtLeast(19, YEARS)
            ) || (
              user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
              && user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].questions["CONSENT_ASSENT_CHILD_DOB"].answers.ageAtLeast(18, YEARS)
            )
          )
        ) || (
          user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["COUNTRY"].answers.hasOption("PR")
          && user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].questions["CONSENT_ASSENT_CHILD_DOB"].answers.ageAtLeast(21, YEARS)
        ) || (
          user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
          && user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].questions["CONSENT_ASSENT_CHILD_DOB"].answers.ageAtLeast(18, YEARS)
        )
      )""",
    "messageTemplate": {
      "templateType": "HTML",
      "templateText": "$dob_need_child_assent",
      "variables": [
        {
          "name": "dob_need_child_assent",
          "translations": [
            {"language": "en", "text": "Please check the date of birth you entered for your child. If the date is correct, then your child has reached the age of majority and must self-enroll in order to participate in this study. If you think there is a mistake, please reach out to us at <a href=\"tel:651-403-5315\" class=\"Link\">651-403-5315</a> or <a href=\"mailto:info@joincountmein.org\" class=\"Link\">info@joincountmein.org</a>."},
          ]
        }
      ]
    }
  },
    {
      "stableIds": ["CONSENT_ASSENT_CHILD_DOB"],
      "precondition": """ user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].questions["CONSENT_ASSENT_CHILD_DOB"].isAnswered() """,
      "expression": """!user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].questions["CONSENT_ASSENT_CHILD_DOB"].answers.ageAtLeast(7, YEARS)""",
      "messageTemplate": {
        "templateType": "HTML",
        "templateText": "$dob_child_assent",
        "variables": [
          {
            "name": "dob_child_assent",
            "translations": [
              {"language": "en", "text": "Please check the date of birth you entered for your child. If the date is correct, then your child does not need to give their own assent to participate in the study. In that case, please restart the process with a different email address, or contact us for help at <a href=\"tel:651-403-5315\" class=\"Link\">651-403-5315</a> or <a href=\"mailto:info@joincountmein.org\" class=\"Link\">info@joincountmein.org</a>."},
            ]
          }
        ]
      }
    }
  ]
  },
  {
    "Code": "CONSENT",
    "validation": [
      {
      "stableIds": ["CONSENT_DOB"],
      "precondition": """user.studies["CMI-OSTEO"].forms["PREQUAL"].hasInstance() &&
      """${_pex.is_self}""" && user.studies["CMI-OSTEO"].forms["CONSENT"].questions["CONSENT_DOB"].isAnswered()""",
      "expression": """ (
        ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("US")
          && (
            ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_STATE"].answers.hasOption("AL")
              && !user.studies["CMI-OSTEO"].forms["CONSENT"].questions["CONSENT_DOB"].answers.ageAtLeast(19, YEARS)
            ) || (
              !user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_STATE"].answers.hasOption("AL")
              && !user.studies["CMI-OSTEO"].forms["CONSENT"].questions["CONSENT_DOB"].answers.ageAtLeast(18, YEARS)
            )
          )
        ) || (
          user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("CA")
          && (
            ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
              && !user.studies["CMI-OSTEO"].forms["CONSENT"].questions["CONSENT_DOB"].answers.ageAtLeast(19, YEARS)
            ) || (
              user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
              && !user.studies["CMI-OSTEO"].forms["CONSENT"].questions["CONSENT_DOB"].answers.ageAtLeast(18, YEARS)
            )
          )
        ) || (
          user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("PR")
          && !user.studies["CMI-OSTEO"].forms["CONSENT"].questions["CONSENT_DOB"].answers.ageAtLeast(21, YEARS)
        ) || (
          user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
          && !user.studies["CMI-OSTEO"].forms["CONSENT"].questions["CONSENT_DOB"].answers.ageAtLeast(18, YEARS)
        )
      ) """,
      "messageTemplate": {
        "templateType": "HTML",
        "templateText": "$dob_need_consent",
        "variables": [
          {
            "name": "dob_need_consent",
            "translations": [
              {"language": "en", "text": "Please check the date of birth you have entered. If the date is correct, then you are younger than the age required by local law to self-enroll in this study. However, you may ask your parent or guardian to enroll you in the study. If you think there is a mistake, please reach out to us at <a href=\"tel:651-403-5315\" class=\"Link\">651-403-5315</a> or <a href=\"mailto:info@joincountmein.org\" class=\"Link\">info@joincountmein.org</a>."},
            ]
          }
        ]
      }
    },
      {
        "stableIds": ["CONSENT_DOB"],
        "precondition": """(user.studies["CMI-OSTEO"].forms["PREQUAL"].hasInstance() && (!user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
          && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED"))) && user.studies["CMI-OSTEO"].forms["CONSENT"].questions["CONSENT_DOB"].isAnswered() """,
        "expression": """
            user.studies["CMI-OSTEO"].forms["CONSENT"].questions["CONSENT_DOB"].answers.value() != user.profile.birthDate()
          """,
        "messageTemplate": {
          "templateType": "HTML",
          "templateText": "$validation_dob_ageup",
          "variables": [
            {
              "name": "validation_dob_ageup",
              "translations": [
                { "language": "en", "text": "The date of birth you entered is different from what was previously entered by your parent or guardian. Please check the date you entered and correct any errors. If you think there is a mistake, please reach out to us at <a href=\"tel:651-403-5315\" class=\"Link\">651-403-5315</a> or <a href=\"mailto:info@joincountmein.org\" class=\"Link\">info@joincountmein.org</a>." },
              ]
            }
          ]
        }
      },
    ]
  }
]