<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet id="DROP_AUTH0_DOMAIN_COLUMN" author="Dmitrii">
        <preConditions onError="MARK_RAN" onFail="MARK_RAN">
            <columnExists tableName="client" columnName="auth0_domain" />
        </preConditions>

        <dropNotNullConstraint tableName="client" columnName="auth0_domain" columnDataType="varchar(255)"/>
        <dropColumn tableName="client" columnName="auth0_domain"/>
    </changeSet>

    <changeSet id="DDP-2606-backfill-auth0-tenant" author="andrew">
        <sql>
            update umbrella_study s set s.auth0_tenant_id = (select auth0_tenant_id from auth0_tenant order by auth0_tenant_id asc limit 1)
            where s.auth0_tenant_id is null
        </sql>

        <sql>
            update client c set c.auth0_tenant_id = (select auth0_tenant_id from auth0_tenant order by auth0_tenant_id asc limit 1)
            where c.auth0_tenant_id is null
        </sql>

        <sql>
            update user set auth0_tenant_id = (select auth0_tenant_id from auth0_tenant order by auth0_tenant_id asc limit 1)
            where auth0_tenant_id is null
        </sql>

        <addNotNullConstraint tableName="client" columnName="auth0_tenant_id" columnDataType="bigint"/>

        <addNotNullConstraint tableName="umbrella_study" columnName="auth0_tenant_id" columnDataType="bigint"/>

        <addUniqueConstraint tableName="user" columnNames="auth0_user_id,auth0_tenant_id" constraintName="user_auth0_tenant_uk"/>

        <addNotNullConstraint tableName="user" columnName="auth0_tenant_id" columnDataType="bigint"/>

    </changeSet>

</databaseChangeLog>
