version: 2.1

setup: true

orbs:
  path-filtering: circleci/path-filtering@0.1.1
  continuation: circleci/continuation@0.2.0

parameters:
  on_demand:
    type: boolean
    default: false
  project:
    type: enum
    enum: ["dss", "dsm","api-docs", "nothing"]
    default: "nothing"

workflows:
  build-test-workflow:
    when:
      and:
        - << pipeline.parameters.on_demand >>
        - equal: ["nothing", << pipeline.parameters.project >>]
    jobs:
      - path-filtering/filter:
          base-revision: develop
          config-path: .circleci/main-config.yml
          mapping: |
            pepper-apis/.* action "build-test"
            pepper-apis/pom.xml dss true
            pepper-apis/((dss-.*)|(ddp-.*)|(pex-antlr)|(housekeeping)|(studybuilder-cli))/.* dss true
            pepper-apis/((dsm-.*)|(ddp-.*))/.* dsm true
            pepper-apis/docs/.* api-docs true

  build-test-deploy-workflow:
    when:
      and:
        - not: << pipeline.parameters.on_demand >>
        - equal: ["nothing", << pipeline.parameters.project >>]
    jobs:
      - path-filtering/filter:
          base-revision: develop
          config-path: .circleci/main-config.yml
          mapping: |
            pepper-apis/.* action "build-test-deploy"
            pepper-apis/pom.xml dss true
            pepper-apis/((dss-.*)|(ddp-.*)|(pex-antlr)|(housekeeping)|(studybuilder-cli))/.* dss true
            pepper-apis/((dsm-.*)|(ddp-.*))/.* dsm true
            pepper-apis/docs/.* api-docs true
          filters: #todo get rid of this filter when done
            branches:
              only:
                - develop

  dss-api-build-test-store-workflow:
    when:
      and:
        - not: << pipeline.parameters.on_demand >>
        - equal: ["nothing", << pipeline.parameters.project >>]
    jobs:
      - continuation/continue:
          configuration_path: .circleci/main-config.yml
          parameters: '{"action":"build-test-store","dss": true,"api-docs": true}'
          filters:
            branches:
              only:
                - /^rc.*/
                - /^hotfix.*/

  dsm-build-test-store-workflow:
    when:
      and:
        - not: << pipeline.parameters.on_demand >>
        - equal: ["nothing", << pipeline.parameters.project >>]
    jobs:
      - continuation/continue:
          configuration_path: .circleci/main-config.yml
          parameters: '{"action":"build-test-store","dsm": true}'
          filters:
            branches:
              only:
                - /^dsm_rc.*/
                - /^dsm_hotfix.*/
