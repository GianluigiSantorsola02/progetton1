{
  "tenant": {
    "domain": ${auth0.domain},
    "mgmtClientId": ${auth0.mgmtClientId},
    "mgmtSecret": ${auth0.mgmtSecret}
  },

  "umbrella": {
    "name": "RAREX",
    "guid": "rarex"
  },

  "study": {
    "name": "rarexproject",
    "guid": "rarex",
    "studyEmail": "info@rarexproject.org", //TBD
    "baseWebUrl": ${baseWebUrl},
    "irbPassword": ${irbPassword},
    "plusCodePrecision": "MEDIUM",
    "shareParticipantLocation": true
  },

  "client": {
    "name": "rarex-angular-client",
    "id": ${auth0.clientId},
    "secret": ${auth0.clientSecret},
    "passwordRedirectUrl": ${passwordRedirectUrl}
  },

  include required("sendgrid-emails.conf"),

  "adminUser": {
    "guid": "PEPPERRAREXADMINUSER"
  },

  "governance": {
    "shouldCreateGovernedUserExpr": """
      user.studies["rarex"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
      && (user.studies["rarex"].forms["PARENTAL_CONSENT"].hasInstance() || user.studies["rarex"].forms["CONSENT_ASSENT"].hasInstance())
    """,
    "ageOfMajorityRules": [
      ### 'I have been diagnosed' ###
      # AoM  for U.S.
      {
        "condition": """
          user.studies["rarex"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
          && user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("US")
          && user.studies["rarex"].forms["PREQUAL"].questions["SELF_STATE"].answers.hasOption("AL")
        """,
        "age": 19,
        "prepMonths": 4
      },
      {
        "condition": """
          user.studies["rarex"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
          && user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("US")
          && !user.studies["rarex"].forms["PREQUAL"].questions["SELF_STATE"].answers.hasOption("AL")
        """,
        "age": 18,
        "prepMonths": 4
      },
      # Aom for Puerto Rico
      {
        "condition": """
          user.studies["rarex"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
          && user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("PR")
        """,
        "age": 21,
        "prepMonths": 4
      },
      # Aom for other U.S. Territories
      {
        "condition": """
          user.studies["rarex"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
          && user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
        """,
        "age": 18,
        "prepMonths": 4
      },
      # AoM for Canada
      {
        "condition": """
          user.studies["rarex"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
          && user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("CA")
          && user.studies["rarex"].forms["PREQUAL"].questions["SELF_PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
        """,
        "age": 19,
        "prepMonths": 4
      },
      {
        "condition": """
          user.studies["rarex"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
          && user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("CA")
          && user.studies["rarex"].forms["PREQUAL"].questions["SELF_PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
        """,
        "age": 18,
        "prepMonths": 4
      }

      ### 'My child has been diagnosed' ###
      //TODO: same for childrens cases
    ]
  },

  "studyDetails": [],

  "sendgrid": {
    "apiKey": ${sendgridApiKey},
    "fromName": ${sendgridFromName},
    "fromEmail": ${sendgridFromEmail},
    "defaultSalutation": ${sendgridDefaultSalutation}
  },

  "kits": [],

  "activities": [
    {
      "filepath": "prequal.conf",
      "mappings": [],
      "validations": [# complex validations for international patients
        {
          "messageTemplate": {
            "templateType": "HTML",
            "templateText": "$rarex_prequal_validation_self_international",
            "variables": [
              {
                "name": "rarex_prequal_validation_self_international",
                "translations": [
                  {
                    "language": "en",
                    "text": """The RARE-X Data Collection Platform is currently open only to participants in the United States or Canada."""
                  }
                ]
              }
            ]
          },
          "stableIds": ["SELF_COUNTRY"],
          "precondition": """
            user.studies["rarex"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
            && user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].isAnswered()
          """,
          "expression": """
            !user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasAnyOption("US", "CA", "PR", "GU", "VI", "MP", "AS")
          """
        },
        {
          "messageTemplate": {
            "templateType": "HTML",
            "templateText": "$rarex_prequal_validation_child_international",
            "variables": [
              {
                "name": "rarex_prequal_validation_child_international",
                "translations": [
                  {
                    "language": "en",
                    "text": """The RARE-X Data Collection Platform is currently open only to participants in the United States or Canada."""
                  }
                ]
              }
            ]
          },
          "stableIds": ["CHILD_COUNTRY"],
          "precondition": """
            user.studies["rarex"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
            && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COUNTRY"].isAnswered()
          """,
          "expression": """
            !user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasAnyOption("US", "CA", "PR", "GU", "VI", "MP", "AS")
          """
        },

        # complex validation for requiring parental consent
        {
          "messageTemplate": {
            "templateType": "HTML",
            "templateText": "$rarex_prequal_validation_need_parental_consent",
            "variables": [
              {
                "name": "rarex_prequal_validation_need_parental_consent",
                "translations": [
                  {
                    "language": "en",
                    "text": """
                      <span class="bold">Due to your age, a parental consent will be required to enroll. Please ask parent or guardian to sign up for you on the previous page.
                    """
                  }
                ]
              }
            ]
          },
          "stableIds": ["SELF_CURRENT_AGE", "SELF_COUNTRY", "SELF_STATE", "SELF_PROVINCE"],
          "precondition": """
            user.studies["rarex"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
            && user.studies["rarex"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].isAnswered()
            && user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].isAnswered()
            && (
              !user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasAnyOption("US", "CA")
              || (
                user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("US")
                && user.studies["rarex"].forms["PREQUAL"].questions["SELF_STATE"].isAnswered()
              ) || (
                user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("CA")
                && user.studies["rarex"].forms["PREQUAL"].questions["SELF_PROVINCE"].isAnswered()
              )
            )
          """,
          "expression": """
            ( user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("US")
              && (
                ( user.studies["rarex"].forms["PREQUAL"].questions["SELF_STATE"].answers.hasOption("AL")
                  && user.studies["rarex"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() < 19
                ) || (
                  !user.studies["rarex"].forms["PREQUAL"].questions["SELF_STATE"].answers.hasOption("AL")
                  && user.studies["rarex"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() < 18
                )
              )
            ) || (
              user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("CA")
              && (
                ( user.studies["rarex"].forms["PREQUAL"].questions["SELF_PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
                  && user.studies["rarex"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() < 19
                ) || (
                  user.studies["rarex"].forms["PREQUAL"].questions["SELF_PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
                  && user.studies["rarex"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() < 18
                )
              )
            ) || (
              user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("PR")
              && user.studies["rarex"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() < 21
            ) || (
              user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
              && user.studies["rarex"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() < 18
            )
          """
        },

        # complex validation for requiring child to self-consent
        {
          "messageTemplate": {
            "templateType": "HTML",
            "templateText": "$rarex_prequal_validation_child_self_consent",
            "variables": [
              {
                "name": "rarex_prequal_validation_child_self_consent",
                "translations": [
                  {
                    "language": "en",
                    "text": "As the patient is cognitively capable of participating themselves and has reached the age of majority, please have the patient sign up on the previous page."
                  }
                ]
              }
            ]
          },
          "stableIds": ["CHILD_CURRENT_AGE"],
          "precondition": """
            user.studies["rarex"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
            && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].isAnswered()
            && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COUNTRY"].isAnswered()
            && (
              !user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasAnyOption("US", "CA")
              || (
                user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("US")
                && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_STATE"].isAnswered()
              ) || (
                user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("CA")
                && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_PROVINCE"].isAnswered()
              )
            )
          """,
          "expression": """
            (( user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("US")
              && (
                ( user.studies["rarex"].forms["PREQUAL"].questions["CHILD_STATE"].answers.hasOption("AL")
                  && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() >= 19
                ) || (
                  !user.studies["rarex"].forms["PREQUAL"].questions["CHILD_STATE"].answers.hasOption("AL")
                  && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() >= 18
                )
              )
            ) || (
              user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("CA")
              && (
                ( user.studies["rarex"].forms["PREQUAL"].questions["CHILD_PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
                  && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() >= 19
                ) || (
                  user.studies["rarex"].forms["PREQUAL"].questions["CHILD_PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
                  && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() >= 18
                )
              )
            ) || (
              user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("PR")
              && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() >= 21
            ) || (
              user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
              && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() >= 18
            )) && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COGNITIVELY_CAPABLE"].answers.hasOption("YES")
          """
        }
      ]
    },
    {
      "filepath": "self-consent.conf",
      "mappings": [
        {
          "type": "DATE_OF_BIRTH",
          "stableId": "CONSENT_DOB"
        }
      ],
      "validations": []
    },
    {
      "filepath": "parental-consent.conf",
      "mappings": [
        {
          "type": "DATE_OF_BIRTH",
          "stableId": "PARENTAL_CONSENT_CHILD_DOB"
        }
      ],
      "validations": []
    },
    {
      "filepath": "consent-assent.conf",
      "mappings": [
        {
          "type": "BLOOD",
          "stableId": "CONSENT_ASSENT_BLOOD"
        },
        {
          "type": "TISSUE",
          "stableId": "CONSENT_ASSENT_TISSUE"
        },
        {
          "type": "DATE_OF_BIRTH",
          "stableId": "CONSENT_ASSENT_CHILD_DOB"
        }
      ],
      "validations": []
    },
    {
      "filepath": "legacy.conf",
      "mappings": [],
      "validations": []
    },
    {
      "filepath": "demographics.conf",
      "mappings": [],
      "validations": []
    },
    {
      "filepath": "data-sharing.conf",
      "mappings": [],
      "validations": []
    },
    {
      "filepath": "medical-background-survey.conf",
      "mappings": [],
      "validations": []
    },
//    {
//      "filepath": "neuro-development.conf",
//      "mappings": [],
//      "validations": []
//    },
    {
      "filepath": "quality-of-life.conf",
      "mappings": [],
      "validations": []
    }
  ],

  "activityTimestamp": null,

  "activityStatusIcons": [],

  "pdfs": [],

  "workflowTransitions": [
    # main study workflow
    {
      "from": {
        "type": "START"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "PREQUAL",
          "expression": "true"
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "PREQUAL",
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "CONSENT",
          "expression": """user.studies["rarex"].forms["CONSENT"].hasInstance()"""
        },
        {
          "type": "ACTIVITY",
          "activityCode": "PARENTAL_CONSENT",
          "expression": """user.studies["rarex"].forms["PARENTAL_CONSENT"].hasInstance()"""
        },
        {
          "type": "ACTIVITY",
          "activityCode": "CONSENT_ASSENT",
          "expression": """user.studies["rarex"].forms["CONSENT_ASSENT"].hasInstance()"""
        },
        {
          "type": "ACTIVITY",
          "activityCode": "LEGACY",
          "expression": """user.studies["rarex"].forms["LEGACY"].hasInstance()"""
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY"
        "activityCode": "CONSENT"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "DEMOGRAPHICS",
          "expression": """user.studies["rarex"].forms["DEMOGRAPHICS"].hasInstance()"""
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "PARENTAL_CONSENT"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "DEMOGRAPHICS",
          "expression": """user.studies["rarex"].forms["DEMOGRAPHICS"].hasInstance()"""
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "CONSENT_ASSENT"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "DEMOGRAPHICS",
          "expression": """user.studies["rarex"].forms["DEMOGRAPHICS"].hasInstance()"""
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY"
        "activityCode": "DEMOGRAPHICS"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "DATA_SHARING",
          "expression": """user.studies["rarex"].forms["GENERAL_MEDICAL_BACKGROUND_SURVEY"].hasInstance()"""
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY"
        "activityCode": "DATA_SHARING"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "GENERAL_MEDICAL_BACKGROUND_SURVEY",
          "expression": """user.studies["rarex"].forms["GENERAL_MEDICAL_BACKGROUND_SURVEY"].hasInstance()"""
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY"
        "activityCode": "GENERAL_MEDICAL_BACKGROUND_SURVEY"
      },
//      "to": [
//        {
//          "type": "ACTIVITY",
//          "activityCode": "GENERAL_NEURO_DEVELOPMENT",
//          "expression": """user.studies["rarex"].forms["GENERAL_NEURO_DEVELOPMENT"].hasInstance()"""
//        }
//      ]
//    },
//    {
//      "from": {
//        "type": "ACTIVITY"
//        "activityCode": "GENERAL_NEURO_DEVELOPMENT"
//      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "QUALITY_OF_LIFE",
          "expression": """user.studies["rarex"].forms["QUALITY_OF_LIFE"].hasInstance()"""
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "QUALITY_OF_LIFE"
      },
      "to": [
        {
          "type": "DASHBOARD",
          "expression": """user.studies["rarex"].forms["QUALITY_OF_LIFE"].isStatus("COMPLETE")"""
        }
      ]
    },

    # legacy survey workflow
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "LEGACY"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "LEGACY",
          "expression": """user.studies["rarex"].forms["LEGACY"].isStatus("CREATED", "IN_PROGRESS")"""
        },
        {
          "type": "THANK_YOU",
          "expression": """user.studies["rarex"].forms["LEGACY"].isStatus("COMPLETE")"""
        }
      ]
    }
  ],

  "events": [
    # activity instance creation events
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PREQUAL",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "CONSENT"
      },
      "preconditionExpr": """user.studies["rarex"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
        && (
          ( user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("US")
            && (
              ( user.studies["rarex"].forms["PREQUAL"].questions["SELF_STATE"].answers.hasOption("AL")
                && user.studies["rarex"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() >= 19
              ) || (
                !user.studies["rarex"].forms["PREQUAL"].questions["SELF_STATE"].answers.hasOption("AL")
                && user.studies["rarex"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() >= 18
              )
            )
          ) || (
            user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("CA")
            && (
              ( user.studies["rarex"].forms["PREQUAL"].questions["SELF_PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
                && user.studies["rarex"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() >= 19
              ) || (
                user.studies["rarex"].forms["PREQUAL"].questions["SELF_PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
                && user.studies["rarex"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() >= 18
              )
            )
          ) || (
            user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("PR")
            && user.studies["rarex"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() >= 21
          ) || (
            user.studies["rarex"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
            && user.studies["rarex"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() >= 18
          )
        )
      """,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PREQUAL",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "PARENTAL_CONSENT"
      },
      "preconditionExpr": """user.studies["rarex"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
        && (
             user.studies["rarex"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() < 7) ||
             user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COGNITIVELY_CAPABLE"].answers.hasOption("NO")
           )""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PREQUAL",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "CONSENT_ASSENT"
      },
      "preconditionExpr": """user.studies["rarex"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
        && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() >= 7
        && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COGNITIVELY_CAPABLE"].answers.hasOption("YES")
        && (
          ( user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("US")
            && (
              ( user.studies["rarex"].forms["PREQUAL"].questions["CHILD_STATE"].answers.hasOption("AL")
                && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() < 19
              ) || (
                !user.studies["rarex"].forms["PREQUAL"].questions["CHILD_STATE"].answers.hasOption("AL")
                && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() < 18
              )
            )
          ) || (
            user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("CA")
            && (
              ( user.studies["rarex"].forms["PREQUAL"].questions["CHILD_PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
                && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() < 19
              ) || (
                user.studies["rarex"].forms["PREQUAL"].questions["CHILD_PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
                && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() < 18
              )
            )
          ) || (
            user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("PR")
            && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() < 21
          ) || (
            user.studies["rarex"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
            && user.studies["rarex"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() < 18
          )
        )
        """,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PREQUAL",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "LEGACY"
      },
      "preconditionExpr": """user.studies["rarex"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("PASSED_AWAY")""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "DEMOGRAPHICS"
      },
      "preconditionExpr": null,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "DATA_SHARING"
      },
      "preconditionExpr": null,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "GENERAL_MEDICAL_BACKGROUND_SURVEY"
      },
      "preconditionExpr": null,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
//    {
//      "trigger": {
//        "type": "ACTIVITY_STATUS",
//        "activityCode": "CONSENT",
//        "statusType": "COMPLETE"
//      },
//      "action": {
//        "type": "ACTIVITY_INSTANCE_CREATION",
//        "activityCode": "GENERAL_NEURO_DEVELOPMENT"
//      },
//      "preconditionExpr": null,
//      "maxOccurrencesPerUser": 1,
//      "dispatchToHousekeeping": false,
//      "order": 1
//    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "QUALITY_OF_LIFE"
      },
      "preconditionExpr": null,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PARENTAL_CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "DATA_SHARING"
      },
      "preconditionExpr": null,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PARENTAL_CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "DEMOGRAPHICS"
      },
      "preconditionExpr": null,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PARENTAL_CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "GENERAL_MEDICAL_BACKGROUND_SURVEY"
      },
      "preconditionExpr": null,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
//    {
//      "trigger": {
//        "type": "ACTIVITY_STATUS",
//        "activityCode": "PARENTAL_CONSENT",
//        "statusType": "COMPLETE"
//      },
//      "action": {
//        "type": "ACTIVITY_INSTANCE_CREATION",
//        "activityCode": "GENERAL_NEURO_DEVELOPMENT"
//      },
//      "preconditionExpr": null,
//      "maxOccurrencesPerUser": 1,
//      "dispatchToHousekeeping": false,
//      "order": 1
//    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PARENTAL_CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "QUALITY_OF_LIFE"
      },
      "preconditionExpr": null,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ASSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "DATA_SHARING"
      },
      "preconditionExpr": null,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ASSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "DEMOGRAPHICS"
      },
      "preconditionExpr": null,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ASSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "GENERAL_MEDICAL_BACKGROUND_SURVEY"
      },
      "preconditionExpr": null,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
//    {
//      "trigger": {
//        "type": "ACTIVITY_STATUS",
//        "activityCode": "CONSENT_ASSENT",
//        "statusType": "COMPLETE"
//      },
//      "action": {
//        "type": "ACTIVITY_INSTANCE_CREATION",
//        "activityCode": "GENERAL_NEURO_DEVELOPMENT"
//      },
//      "preconditionExpr": null,
//      "maxOccurrencesPerUser": 1,
//      "dispatchToHousekeeping": false,
//      "order": 1
//    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ASSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "QUALITY_OF_LIFE"
      },
      "preconditionExpr": null,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    # email events

    ##welcome email
    {
      "trigger": {
        "type": "USER_REGISTERED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          {
            "emailTemplate": ${emails.signUpWelcome},
            "language": "en",
            "isDynamic": false
          }
        ],
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ##finish consent 1 week reminder
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "IN_PROGRESS"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          {
            "emailTemplate": ${emails.finishConsent1wkReminder},
            "language": "en",
            "isDynamic": false
          }
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """(user.studies["rarex"].forms["CONSENT"].hasInstance()
        && user.studies["rarex"].forms["CONSENT"].isStatus("COMPLETE"))""",
      "delaySeconds": 604800,
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ##Consent finished notification
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          {
            "emailTemplate": ${emails.consentCompletedNotification},
            "language": "en",
            "isDynamic": false
          }
        ],
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ##Demographics completion reminder
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "DEMOGRAPHICS",
        "statusType": "IN_PROGRESS"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          {
            "emailTemplate": ${emails.finishDemographicsReminder},
            "language": "en",
            "isDynamic": false
          }
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """(user.studies["rarex"].forms["DEMOGRAPHICS"].hasInstance()
        && user.studies["rarex"].forms["DEMOGRAPHICS"].isStatus("COMPLETE"))""",
      "delaySeconds": 60, #1 min, for testing purspose
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ##Medical background completion reminder
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "GENERAL_MEDICAL_BACKGROUND_SURVEY",
        "statusType": "IN_PROGRESS"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          {
            "emailTemplate": ${emails.finishMedicalBackgroundReminder},
            "language": "en",
            "isDynamic": false
          }
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """(user.studies["rarex"].forms["GENERAL_MEDICAL_BACKGROUND_SURVEY"].hasInstance()
        && user.studies["rarex"].forms["GENERAL_MEDICAL_BACKGROUND_SURVEY"].isStatus("COMPLETE"))""",
      "delaySeconds": 60, #for testing purpose
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ##Quality of life completion reminder
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "QUALITY_OF_LIFE",
        "statusType": "IN_PROGRESS"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          {
            "emailTemplate": ${emails.finishQualityOfLifeReminder},
            "language": "en",
            "isDynamic": false
          }
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """(user.studies["rarex"].forms["QUALITY_OF_LIFE"].hasInstance()
        && user.studies["rarex"].forms["QUALITY_OF_LIFE"].isStatus("COMPLETE"))""",
      "delaySeconds": 60, #1 min, for testing purspose
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ##Quality of life completion reminder
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "DATA_SHARING",
        "statusType": "IN_PROGRESS"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          {
            "emailTemplate": ${emails.finishDataSharingReminder},
            "language": "en",
            "isDynamic": false
          }
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """(user.studies["rarex"].forms["DATA_SHARING"].hasInstance()
        && user.studies["rarex"].forms["DATA_SHARING"].isStatus("COMPLETE"))""",
      "delaySeconds": 60, #1 min, for testing purspose
      "dispatchToHousekeeping": true,
      "order": 1
    },

  ]
}
